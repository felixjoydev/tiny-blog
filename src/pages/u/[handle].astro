---
import Layout from "../../layouts/Layout.astro";
import { createSupabaseServerClient } from "../../lib/supabaseServer";
import ProfilePage from "../../components/islands/ProfilePage.jsx";

export const prerender = false;

const { handle } = Astro.params;

if (!handle) {
  return Astro.redirect("/");
}

const supabase = createSupabaseServerClient(Astro.cookies);

// Fetch profile by handle
const { data: profile, error } = await supabase
  .from("profiles")
  .select("*")
  .eq("handle", handle.toLowerCase())
  .single();

if (error || !profile) {
  // Not found - check if it's an old handle alias
  const { data: alias, error: aliasError } = await supabase
    .from("profile_handle_aliases")
    .select("profile_id")
    .eq("old_handle", handle.toLowerCase())
    .maybeSingle();

  if (alias && !aliasError) {
    // Alias found - fetch current handle and redirect (301 permanent)
    const { data: currentProfile, error: currentProfileError } = await supabase
      .from("profiles")
      .select("handle")
      .eq("id", alias.profile_id)
      .single();

    if (currentProfile && !currentProfileError && currentProfile.handle) {
      return Astro.redirect(`/u/${currentProfile.handle}`, 301);
    }
  }

  // No profile or alias found - return 404
  return new Response(null, {
    status: 404,
    statusText: "Profile not found",
  });
}

// Profile found - render using the UUID
const profileId = profile.id;
---

<Layout title={`@${profile.handle} - ${profile.display_name} - Tiny Blog`}>
  <ProfilePage profileId={profileId} initialProfile={profile} client:load />
</Layout>
