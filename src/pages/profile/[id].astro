---
import Layout from "../../layouts/Layout.astro";
import { createSupabaseServerClient } from "../../lib/supabaseServer";
import ProfilePage from "../../components/islands/ProfilePage.jsx";

export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/");
}

const supabase = createSupabaseServerClient(Astro.cookies);

// Fetch profile data
const { data: profile, error } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", id)
  .single();

if (error || !profile) {
  return Astro.redirect("/");
}

// Redirect to handle-based URL if handle exists (307 temporary redirect)
if (profile.handle) {
  return Astro.redirect(`/u/${profile.handle}`, 307);
}

// Fallback: render for profiles without handles (legacy support)
---

<Layout title={`${profile.display_name} - Tiny Blog`}>
  <ProfilePage profileId={id} initialProfile={profile} client:load />
</Layout>
